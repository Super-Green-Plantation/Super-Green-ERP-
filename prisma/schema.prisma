generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Status {
  Active
  Inactive
}

enum ReturnFrequency {
  Monthly
  HalfYearly
  Yearly
}

model Branch {
  id        Int      @id @default(autoincrement())
  name      String
  location  String
  members   Member[]
  status    Status   @default(Active)
  client    Client[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Title {
  AGM
  ZM
  RM
  BM
  TL
  FA
}

model Position {
  id         Int   @id @default(autoincrement())
  title      Title
  baseSalary Float
  rank       Int   @unique

  orc CommissionRate?

  members Member[]

  personalCommissionTiers PersonalCommissionTier[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CommissionRate {
  id         Int      @id @default(autoincrement())
  rate       Decimal?
  position   Position @relation(fields: [positionId], references: [id])
  positionId Int      @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model PersonalCommissionTier {
  id         Int     @id @default(autoincrement())
  positionId Int
  minAmount  Float
  maxAmount  Float? // null = no upper limit
  rate       Decimal

  position Position @relation(fields: [positionId], references: [id])

  @@index([positionId])
}

//many side ekata foreign key eka / Parent has an array
model Member {
  id    Int     @id @default(autoincrement())
  name  String
  email String? @unique
  phone String?
  empNo String  @unique

  totalCommission Float @default(0)

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id])

  positionId Int
  // /job title
  position   Position @relation(fields: [positionId], references: [id])

  //higher member
  // managerId Int? // ðŸ‘ˆ REPORTING TO

  // manager      Member?  @relation("MemberHierarchy", fields: [managerId], references: [id])
  // subordinates Member[] @relation("MemberHierarchy")

  commissions Commission[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  investments Investment[]
}

model FinancialPlan {
  id          Int          @id @default(autoincrement())
  name        String
  duration    Int // months
  rate        Float
  description String
  status      Status       @default(Active)
  investment  Float?
  investments Investment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Client {
  id Int @id @default(autoincrement())

  fullName       String
  nic            String? @unique
  drivingLicense String? @unique
  passportNo     String? @unique

  email       String? @unique
  phoneMobile String?
  phoneLand   String?

  dateOfBirth DateTime?
  occupation  String?

  address          String
  investmentAmount Int

  signature String?
  idFront   String?
  idBack    String?
  proposal  String?
  agreement String?

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id])

  status Status @default(Active)

  investments Investment[]
  beneficiary Beneficiary?
  nominee     Nominee?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Beneficiary {
  id Int @id @default(autoincrement())

  fullName String
  nic      String?
  phone    String

  bankName   String
  bankBranch String
  accountNo  String

  relationship String

  clientId Int    @unique
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Nominee {
  id Int @id @default(autoincrement())

  fullName         String
  permanentAddress String
  postalAddress    String?

  clientId Int    @unique
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Investment {
  id Int @id @default(autoincrement())

  investmentDate DateTime
  amount         Float

  clientId Int
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  planId Int?
  plan   FinancialPlan? @relation(fields: [planId], references: [id])

  advisorId Int?
  advisor   Member? @relation(fields: [advisorId], references: [id])

  commission Commission[]

  commissionsProcessed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Commission {
  id           Int            @id @default(autoincrement())
  investmentId Int
  memberEmpNo  String
  amount       Float
  type         CommissionType
  createdAt    DateTime       @default(now())

  member     Member     @relation(fields: [memberEmpNo], references: [empNo])
  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([investmentId])
  @@index([memberEmpNo])
}

enum CommissionType {
  PERSONAL
  UPLINE
}
